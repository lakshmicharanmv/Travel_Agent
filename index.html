<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Travel Assistant</title>
    
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                        },
                        secondary: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        accent: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            200: '#bbf7d0',
                            300: '#86efac',
                            400: '#4ade80',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d',
                            800: '#166534',
                            900: '#14532d',
                        },
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            400: 'rgba(255, 255, 255, 0.4)',
                            dark: 'rgba(17, 24, 39, 0.6)',
                        },
                        pastel: {
                            blue: '#E0F2FE',
                            pink: '#FCE7F3',
                            purple: '#F3E8FF',
                            teal: '#CCFBF1',
                        }
                    },
                    animation: {
                        'fly-plane': 'flyPlane 2s ease-in-out forwards',
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in-down': 'fadeInDown 0.5s ease-out forwards',
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'pulse-slow': 'pulse 3s infinite',
                        'shimmer': 'shimmer 2s linear infinite',
                        'bounce-slight': 'bounceSlight 2s infinite',
                    },
                    keyframes: {
                        flyPlane: {
                            '0%': { transform: 'translateX(0) translateY(0) rotate(0deg)', opacity: '1' },
                            '20%': { transform: 'translateX(60px) translateY(-20px) rotate(-10deg)', opacity: '1' },
                            '100%': { transform: 'translateX(400px) translateY(-100px) rotate(-20deg)', opacity: '0' },
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeInDown: {
                            '0%': { opacity: '0', transform: 'translateY(-20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' },
                        },
                        bounceSlight: {
                            '0%, 100%': { transform: 'translateY(-5%)' },
                            '50%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            transition: background-color 0.5s ease;
        }
        
        /* Enhanced Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        }

        .dark .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }

        /* Neumorphic Inputs */
        .neumorph-input {
            background: #ffffff;
            box-shadow: inset 2px 2px 6px #f1f5f9, inset -2px -2px 6px #ffffff;
            border: 1px solid #e2e8f0;
            color: #1e293b;
        }
        .dark .neumorph-input {
            background: #f8fafc;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #0f172a;
            border: 1px solid #cbd5e1;
        }
        
        .neumorph-input::placeholder {
            color: #64748b;
        }

        /* Custom Scrollbar */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Animated Background Blob */
        .blob-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            overflow: hidden;
            background: linear-gradient(to bottom, #f0fdf4, #dcfce7);
        }
        .dark .blob-bg {
            background: linear-gradient(to bottom, #14532d, #15803d);
        }
        .blob {
            position: absolute;
            filter: blur(90px);
            opacity: 0.5;
            animation: moveBlob 25s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes moveBlob {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(40px, 60px) scale(1.1); }
        }

        .map-pattern {
            background-image: radial-gradient(rgba(150, 150, 150, 0.2) 1px, transparent 1px);
            background-size: 16px 16px;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 h-screen overflow-hidden transition-colors duration-500">

    <div id="root" class="h-full w-full"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- AGENT & API LOGIC ---

        const getWeatherDescription = (code) => {
            const codes = {
                0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
                45: "Fog", 51: "Drizzle", 53: "Moderate drizzle", 61: "Rain", 63: "Moderate rain",
                65: "Heavy rain", 71: "Snow", 80: "Showers", 95: "Thunderstorm"
            };
            return codes[code] || "Unknown";
        };

        class WeatherAgent {
            async getWeather(lat, lon) {
                try {
                    const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const data = await response.json();
                    if (!data.current_weather) throw new Error("No data");
                    const { temperature, weathercode } = data.current_weather;
                    const desc = getWeatherDescription(weathercode);
                    const rainChance = weathercode >= 50 ? Math.floor(Math.random() * 40) + 60 : Math.floor(Math.random() * 20);
                    return { 
                        text: `It's currently ${temperature}°C (${desc}) with a ${rainChance}% chance of rain.`, 
                        raw: { temperature, desc, rainChance, weathercode } 
                    };
                } catch (error) {
                    return { text: "Weather unavailable.", raw: { temperature: "--", desc: "Unavailable", rainChance: 0, weathercode: 0 } };
                }
            }
        }

        class PlacesAgent {
            async getPlaces(lat, lon) {
                try {
                    // Robust Query for OSM Overpass
                    const query = `
                        [out:json][timeout:25];
                        (
                          node(around:10000,${lat},${lon})["tourism"~"attraction|viewpoint|museum|theme_park|zoo"];
                          node(around:10000,${lat},${lon})["historic"~"monument|castle|ruins|fort"];
                          node(around:10000,${lat},${lon})["natural"~"peak|beach"];
                          way(around:5000,${lat},${lon})["leisure"="park"];
                        );
                        out tags center 10;
                    `;
                    const url = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    const rawElements = data.elements || [];
                    const uniqueNames = new Set();
                    const placeNames = [];

                    rawElements.forEach(el => {
                        // FIX: Prioritize English name, fallback to standard name
                        let name = el.tags?.['name:en'] || el.tags?.name;
                        
                        if (name && !uniqueNames.has(name)) {
                            uniqueNames.add(name);
                            placeNames.push(name);
                        }
                    });

                    if (placeNames.length === 0) return this.getFallbackPlaces();

                    const topPlaces = placeNames.slice(0, 5);

                    const enhancedPlaces = await Promise.all(topPlaces.map(async (name) => {
                        let imageUrl = null;
                        let description = "";
                        let type = 'Landmark';
                        
                        // Heuristic Type Detection
                        const n = name.toLowerCase();
                        if (n.includes('fall')) type = 'Waterfall';
                        else if (n.includes('peak') || n.includes('mountain') || n.includes('hill')) type = 'Nature';
                        else if (n.includes('park') || n.includes('garden')) type = 'Park';
                        else if (n.includes('temple') || n.includes('wat ') || n.includes('shrine')) type = 'Temple';
                        else if (n.includes('museum') || n.includes('gallery')) type = 'Museum';
                        else if (n.includes('fort') || n.includes('palace') || n.includes('castle')) type = 'Historic';
                        else if (n.includes('market') || n.includes('mall')) type = 'Shopping';

                        // Wiki Image Fetch
                        try {
                            const wikiUrl = `https://en.wikipedia.org/w/api.php?action=query&format=json&prop=pageimages|extracts&titles=${encodeURIComponent(name)}&pithumbsize=400&exintro&explaintext&redirects=1&origin=*`;
                            const res = await fetch(wikiUrl);
                            const wikiData = await res.json();
                            const pages = wikiData.query?.pages;
                            
                            if (pages) {
                                const pageId = Object.keys(pages)[0];
                                if (pageId !== "-1") {
                                    const page = pages[pageId];
                                    if (page.thumbnail) imageUrl = page.thumbnail.source;
                                    if (page.extract) description = page.extract.substring(0, 100) + "...";
                                }
                            }
                        } catch (e) { console.warn("Wiki fetch failed", e); }

                        if (!imageUrl) imageUrl = `https://placehold.co/400x300/e2e8f0/475569?text=${encodeURIComponent(name)}`;
                        if (!description) description = `A popular ${type.toLowerCase()} destination.`;

                        return {
                            name,
                            imageUrl,
                            description,
                            distance: (Math.random() * 10 + 1).toFixed(1),
                            type
                        };
                    }));

                    return { 
                        text: "Found these top attractions:", 
                        list: enhancedPlaces 
                    };
                } catch (error) {
                    console.error("Places API Error:", error);
                    return this.getFallbackPlaces();
                }
            }

            getFallbackPlaces() {
                return {
                    text: "I couldn't connect to the live attractions database, but here are general recommendations:",
                    list: [
                        { name: "City Center Plaza", type: "Urban", distance: "0.5", description: "The vibrant heart of the city.", imageUrl: "https://placehold.co/400x300/e2e8f0/475569?text=City+Center" },
                        { name: "National Museum", type: "Museum", distance: "1.2", description: "Explore history and culture.", imageUrl: "https://placehold.co/400x300/fef3c7/d97706?text=Museum" },
                        { name: "Central Park", type: "Nature", distance: "2.5", description: "Green space for relaxation.", imageUrl: "https://placehold.co/400x300/dcfce7/16a34a?text=Park" },
                        { name: "Old Market", type: "Shopping", distance: "3.0", description: "Local goods and street food.", imageUrl: "https://placehold.co/400x300/f3e8ff/7e22ce?text=Market" }
                    ]
                };
            }
        }

        class GeminiAgent {
            constructor() { 
                this.apiKey = localStorage.getItem('gemini_api_key') || "AIzaSyCCsZBL0471VxwgN_FwnE-iLicSGmsoUnQ"; 
                this.baseUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent`; 
            }
            
            async generateContent(prompt) {
                this.apiKey = localStorage.getItem('gemini_api_key') || "AIzaSyCCsZBL0471VxwgN_FwnE-iLicSGmsoUnQ";
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                try {
                    if(!this.apiKey) throw new Error("No Key");
                    const response = await fetch(`${this.baseUrl}?key=${this.apiKey}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if(!response.ok) throw new Error("API Error");
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Content generation failed.";
                } catch (e) {
                    return this.getOfflineResponse(prompt);
                }
            }

            async getSmartInsights(city, weather, places) {
                const placeTypes = places.map(p => p.type).join(", ");
                const prompt = `Analyze travel to ${city}. Weather: ${weather}. Top places types: ${placeTypes}.
                Provide these specific insights in strict "Key: Value" format. Keep values short (1-5 words).
                Best Time: [Season/Month]
                Difficulty: [Easy/Moderate/Adventurous]
                Budget: [Low/Medium/High]
                Companions: [Solo/Couple/Family]
                Travel Mode: [Car/Bike/Walk/Trek]
                Safety: [Low/Medium/High]
                Vibe: [Adventure/Relaxing/Nature/Culture]`;

                try {
                    const text = await this.generateContent(prompt);
                    return this.parseInsights(text);
                } catch (e) {
                    return this.getHeuristicInsights(weather, placeTypes);
                }
            }

            parseInsights(text) {
                const insights = {};
                const lines = text.split('\n');
                lines.forEach(line => {
                    const cleanLine = line.replace(/\*|_/g, '').replace(/^-/, '').trim();
                    const [key, val] = cleanLine.split(':');
                    if (key && val) {
                        insights[key.trim().toLowerCase()] = val.trim();
                    }
                });
                if (Object.keys(insights).length < 3) throw new Error("Parsing failed");
                return insights;
            }

            getHeuristicInsights(weather, placeTypes) {
                return {
                    'best time': 'Year-round',
                    'difficulty': 'Moderate',
                    'budget': 'Medium',
                    'companions': 'Friends/Family',
                    'travel mode': 'Public Transport',
                    'safety': 'High',
                    'vibe': 'Culture & Leisure'
                };
            }

            getOfflineResponse(prompt) {
                 const prefix = "⚠️ [Offline Mode]\n\n";
                 if (prompt.includes("itinerary")) return prefix + "**Day 1:** City tour & landmarks.\n**Day 2:** Museum & local food.\n**Day 3:** Shopping & departure.";
                 return "Service unavailable.";
            }
        }

        class TourismOrchestrator {
            constructor() { this.weather = new WeatherAgent(); this.places = new PlacesAgent(); }
            
            async process(input) {
                let location = input.trim();
                
                // 1. Aggressive cleaning to isolate city name from common sentence structures
                // Matches: "What are the places in X", "Tourist places in X", "Show me attractions in X"
                let cleanInput = input;
                
                // Remove prefixes like "what are the places in", "plan a trip to", etc.
                const prefixes = [
                    "what are the places in", "places in", "attractions in", "tourist places in", 
                    "places to visit in", "best places in", "sightseeing in",
                    "plan a trip to", "plan a trip", "trip to", "visit", "explore", 
                    "travel to", "go to", "show me", "find"
                ];
                
                // Create a dynamic regex from prefixes
                const prefixRegex = new RegExp(`^(${prefixes.join('|')})\\s+`, 'i');
                cleanInput = cleanInput.replace(prefixRegex, "");

                // 2. Try to find the location using prepositional matching if the sentence is complex
                // Matches: "I want to be in Bangalore", "Let's go to Tokyo"
                const match = input.match(/(?:in|to|visit|at|near)\s+([a-zA-Z\s\.-]+)(?:,|\.|\?|$)/i);

                if (match && match[1]) {
                    location = match[1].trim();
                } else {
                    // Fallback to the cleaned string (e.g. "Tourist places Bangalore" -> "Bangalore")
                    location = cleanInput.trim();
                }
                
                // Cleanup trailing punctuation and extra words like "please"
                location = location.replace(/[?.!]+$/, "").replace(/\s+please$/i, "");

                try {
                    // Nominatim Call - FIX: Added accept-language=en to force English results
                    const geoUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(location)}&format=json&limit=1&addressdetails=1&accept-language=en`;
                    
                    const geoRes = await fetch(geoUrl, {
                        headers: {
                            "User-Agent": "TravelAI_Student_Project/1.0 (contact: demo@example.com)" 
                        }
                    });

                    const geoData = await geoRes.json();
                    
                    if (!geoData || !geoData.length) {
                        return { error: `I couldn't find "${location}". Try checking the spelling or use a major city name.` };
                    }
                    
                    const { lat, lon, display_name, address } = geoData[0];
                    const city = address.city || address.town || address.village || address.county || display_name.split(',')[0];
                    
                    const [weatherData, placesData] = await Promise.all([
                        this.weather.getWeather(lat, lon),
                        this.places.getPlaces(lat, lon)
                    ]);

                    return {
                        city: city,
                        full_name: display_name,
                        lat, lon,
                        weather: weatherData,
                        places: placesData
                    };
                } catch (e) { 
                    console.error("Orchestrator Error:", e);
                    return { error: "Connection error. Please check your internet." }; 
                }
            }
        }

        // --- COMPONENTS ---

        const ChatWeatherCard = ({ data }) => {
            if (!data || !data.raw) return null;
            const { temperature, desc, rainChance, weathercode } = data.raw;
            let icon = <i data-lucide="sun" className="w-8 h-8 text-accent-500"></i>;
            if (weathercode > 3) icon = <i data-lucide="cloud" className="w-8 h-8 text-gray-400"></i>;
            if (weathercode > 50) icon = <i data-lucide="cloud-rain" className="w-8 h-8 text-primary-400"></i>;

            return (
                <div className="glass-panel p-4 rounded-2xl rounded-bl-none w-64 mb-4 animate-fade-in-up border-l-4 border-accent-500 bg-white/80 dark:bg-gray-800/80 shadow-lg hover:scale-[1.02] transition duration-300">
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                            {icon}
                            <span className="text-3xl font-bold text-gray-800 dark:text-white">{temperature}°</span>
                        </div>
                        <div className="text-right">
                            <p className="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase">Current</p>
                            <p className="text-xs font-bold text-primary-500">{rainChance}% Rain</p>
                        </div>
                    </div>
                    <p className="text-sm font-medium text-gray-700 dark:text-gray-300 capitalize">{desc}</p>
                </div>
            );
        };

        const ChatLocationCard = ({ data }) => {
            if (!data) return null;
            const { city } = data;
            return (
                <div className="glass-panel p-0 rounded-2xl rounded-bl-none w-64 mb-4 animate-fade-in-up overflow-hidden group cursor-pointer hover:shadow-xl transition duration-300 border-0">
                    <div className="h-24 bg-slate-200 dark:bg-slate-700 map-pattern relative">
                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <div className="absolute bottom-3 left-3 text-white">
                            <h3 className="font-bold text-lg leading-tight">{city}</h3>
                            <p className="text-[10px] opacity-90 flex items-center gap-1"><i data-lucide="map-pin" className="w-3 h-3"></i> Destination Found</p>
                        </div>
                    </div>
                </div>
            );
        };

        const ChatAttractionsCard = ({ data }) => {
            if (!data || data.length === 0) return null;
            return (
                <div className="mb-4 w-full max-w-[85%] animate-fade-in-up">
                    <div className="flex gap-3 overflow-x-auto pb-2 scrollbar-hide snap-x">
                        {data.map((place, idx) => (
                            <div key={idx} onClick={() => window.open(`https://www.google.com/search?q=${encodeURIComponent(place.name)}`, '_blank')} className="glass-panel p-2 rounded-xl min-w-[140px] w-[140px] snap-center hover:bg-white/50 dark:hover:bg-gray-700/50 transition flex-shrink-0 cursor-pointer shadow-sm hover:shadow-md">
                                <div className="h-24 rounded-lg bg-gray-200 dark:bg-gray-700 overflow-hidden mb-2 relative">
                                    <img src={place.imageUrl} alt={place.name} className="w-full h-full object-cover" onError={(e) => e.target.src=`https://placehold.co/140x100/e2e8f0/475569?text=${encodeURIComponent(place.name)}`} />
                                </div>
                                <h4 className="text-xs font-bold text-gray-800 dark:text-white line-clamp-1 mb-0.5">{place.name}</h4>
                                <p className="text-[10px] text-primary-500 dark:text-primary-400 truncate">{place.type}</p>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ChatInsightItem = ({ icon, label, value }) => (
            <div className="flex flex-col items-center justify-center p-2 text-center bg-white/40 dark:bg-gray-800/40 rounded-lg hover:bg-white/60 dark:hover:bg-gray-700/60 transition">
                <div className="mb-1 text-primary-500 dark:text-primary-400 scale-75">{icon}</div>
                <p className="text-[8px] uppercase tracking-wide text-gray-500 dark:text-gray-400 font-bold">{label}</p>
                <p className="text-[10px] font-medium text-gray-800 dark:text-gray-200 leading-tight line-clamp-2">{value}</p>
            </div>
        );

        const ChatSmartInsightsCard = ({ data }) => {
            if (!data) return null;
            return (
                <div className="glass-panel p-3 rounded-2xl rounded-bl-none w-full max-w-md mb-4 animate-fade-in-up shadow-lg">
                    <div className="flex items-center justify-between mb-3 px-1">
                        <div className="flex items-center gap-2">
                            <div className="p-1 bg-secondary-100 dark:bg-secondary-900/30 rounded-md"><i data-lucide="sparkles" className="w-3 h-3 text-secondary-500"></i></div>
                            <span className="text-xs font-bold text-gray-700 dark:text-gray-200">AI Trip Insights</span>
                        </div>
                    </div>
                    <div className="grid grid-cols-3 sm:grid-cols-4 gap-2">
                        <ChatInsightItem icon={<i data-lucide="calendar" className="w-4 h-4"></i>} label="Best Time" value={data['best time']} />
                        <ChatInsightItem icon={<i data-lucide="activity" className="w-4 h-4"></i>} label="Difficulty" value={data['difficulty']} />
                        <ChatInsightItem icon={<i data-lucide="wallet" className="w-4 h-4"></i>} label="Budget" value={data['budget']} />
                        <ChatInsightItem icon={<i data-lucide="car" className="w-4 h-4"></i>} label="Transport" value={data['travel mode']} />
                        <ChatInsightItem icon={<i data-lucide="shield" className="w-4 h-4"></i>} label="Safety" value={data['safety']} />
                        <div className="col-span-2 sm:col-span-2"><ChatInsightItem icon={<i data-lucide="tent" className="w-4 h-4"></i>} label="Vibe" value={data['vibe']} /></div>
                    </div>
                </div>
            );
        };

        const ChatMapCard = ({ data }) => {
            const { lat, lon, city } = data;
            return (
                <div className="glass-panel p-0 rounded-2xl rounded-bl-none w-64 mb-4 animate-fade-in-up overflow-hidden relative group">
                    <div className="h-32 bg-slate-200 dark:bg-slate-700 map-pattern flex items-center justify-center relative">
                        <div className="absolute inset-0 bg-primary-500/5"></div>
                        <i data-lucide="map-pin" className="w-8 h-8 text-red-500 drop-shadow-lg animate-bounce"></i>
                    </div>
                    <div className="absolute bottom-0 w-full p-2 bg-white/80 dark:bg-gray-800/80 backdrop-blur flex justify-between items-center">
                        <span className="text-xs font-medium px-2">{city} Map</span>
                        <button onClick={() => window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lon}`, '_blank')} className="bg-primary-500 hover:bg-primary-600 text-white text-[10px] px-2 py-1 rounded flex items-center gap-1 transition">Open <i data-lucide="external-link" className="w-3 h-3"></i></button>
                    </div>
                </div>
            );
        };

        const ChatBubble = ({ type, text }) => {
            const isAI = type === 'ai';
            const formattedText = text.split('\n').map((line, i) => {
                const parts = line.split(/(\*\*.*?\*\*)/g);
                return (
                    <div key={i} className={`${line.trim().startsWith('•') ? 'pl-4 relative before:content-["•"] before:absolute before:left-0 before:text-primary-400' : ''} min-h-[1.4em] text-slate-700 dark:text-slate-200`}>
                        {parts.map((part, j) => {
                            if (part.startsWith('**') && part.endsWith('**')) return <strong key={j} className="font-bold text-slate-900 dark:text-white">{part.slice(2, -2)}</strong>;
                            return part.replace(/^[•-]\s*/, '');
                        })}
                    </div>
                );
            });

            return (
                <div className={`flex w-full mb-6 animate-fade-in-up ${isAI ? 'justify-start' : 'justify-end'}`}>
                    <div className={`flex max-w-[85%] md:max-w-[75%] ${isAI ? 'flex-row' : 'flex-row-reverse'} items-end gap-3`}>
                        {isAI && <div className="w-8 h-8 rounded-xl bg-gradient-to-tr from-green-500 to-emerald-500 flex items-center justify-center shadow-lg shadow-green-500/30 text-[10px] text-white font-bold shrink-0">AI</div>}
                        <div className={`px-6 py-4 shadow-sm text-sm leading-relaxed ${
                            isAI 
                                ? 'glass-panel rounded-3xl rounded-bl-sm border-white/60' 
                                : 'bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-3xl rounded-br-sm shadow-md'
                        }`}>
                            {formattedText}
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose }) => {
            const [key, setKey] = useState(localStorage.getItem('gemini_api_key') || 'AIzaSyCCsZBL0471VxwgN_FwnE-iLicSGmsoUnQ');
            const [show, setShow] = useState(false);
            const handleSave = () => { localStorage.setItem('gemini_api_key', key.trim()); onClose(); };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-900 rounded-2xl p-6 w-full max-w-md shadow-2xl border border-gray-200 dark:border-gray-700 m-4">
                        <h2 className="text-xl font-bold mb-4 text-gray-800 dark:text-white">Settings</h2>
                        <div className="relative mb-6">
                            <input type={show ? "text" : "password"} value={key} onChange={(e) => setKey(e.target.value)} placeholder="API Key" className="w-full neumorph-input px-4 py-3 rounded-xl outline-none focus:ring-2 focus:ring-primary-500 transition" />
                            <button onClick={() => setShow(!show)} className="absolute right-3 top-3 text-gray-400 hover:text-gray-600"><i data-lucide={show ? "eye-off" : "eye"} className="w-5 h-5"></i></button>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition">Cancel</button>
                            <button onClick={handleSave} className="px-4 py-2 rounded-lg bg-primary-600 text-white hover:bg-primary-700 transition">Save</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ darkMode, setDarkMode, setView, activePanel, setActivePanel, onOpenSettings }) => (
            <div className="hidden md:flex flex-col items-center py-8 w-20 bg-white/30 dark:bg-gray-900/30 backdrop-blur-xl border-r border-white/20 dark:border-gray-700/30 z-50 h-full justify-between flex-shrink-0">
                <div className="flex flex-col gap-8">
                    <div className="p-2 bg-gradient-to-br from-green-500 to-emerald-500 rounded-xl shadow-lg shadow-green-500/30 cursor-pointer" onClick={() => setView('hero')}>
                        <i data-lucide="plane" className="w-6 h-6 text-white"></i>
                    </div>
                    <nav className="flex flex-col gap-6 mt-4">
                        <button onClick={() => { setView('hero'); setActivePanel(null); }} className="p-2 hover:bg-white/20 rounded-xl transition text-gray-600 dark:text-gray-300"><i data-lucide="home" className="w-6 h-6"></i></button>
                        <button onClick={() => setActivePanel(activePanel === 'favorites' ? null : 'favorites')} className={`p-2 rounded-xl transition ${activePanel === 'favorites' ? 'bg-white/20 text-red-500' : 'hover:bg-white/20 text-gray-600 dark:text-gray-300'}`}><i data-lucide="heart" className="w-6 h-6"></i></button>
                        <button onClick={() => setActivePanel(activePanel === 'history' ? null : 'history')} className={`p-2 rounded-xl transition ${activePanel === 'history' ? 'bg-white/20 text-primary-500' : 'hover:bg-white/20 text-gray-600 dark:text-gray-300'}`}><i data-lucide="clock" className="w-6 h-6"></i></button>
                    </nav>
                </div>
                <div className="flex flex-col gap-4">
                    <button onClick={onOpenSettings} className="p-2 hover:bg-white/20 rounded-xl transition text-gray-600 dark:text-gray-300"><i data-lucide="settings" className="w-5 h-5"></i></button>
                    <button onClick={() => setDarkMode(!darkMode)} className="p-2 hover:bg-white/20 rounded-xl transition text-gray-600 dark:text-gray-300"><i data-lucide={darkMode ? "sun" : "moon"} className="w-5 h-5"></i></button>
                </div>
            </div>
        );

        const SidePanel = ({ title, items, onClose, onItemClick, type }) => (
            <div className="absolute left-20 top-0 bottom-0 w-64 bg-white/90 dark:bg-gray-900/95 backdrop-blur-xl border-r border-white/20 dark:border-gray-700 z-40 animate-slide-in p-6 shadow-2xl">
                <div className="flex items-center justify-between mb-6">
                    <h3 className="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-2">
                        <i data-lucide={type === 'favorites' ? "heart" : "clock"} className={`w-5 h-5 ${type === 'favorites' ? 'text-red-500' : 'text-primary-500'}`}></i>
                        {title}
                    </h3>
                    <button onClick={onClose} className="p-1 hover:bg-gray-200 dark:hover:bg-gray-800 rounded-full transition"><i data-lucide="x" className="w-4 h-4"></i></button>
                </div>
                <div className="space-y-2 overflow-y-auto h-[calc(100%-3rem)] scrollbar-hide">
                    {items.length === 0 ? <p className="text-sm text-gray-500 text-center mt-10">List is empty.</p> : items.map((item, idx) => (
                        <button key={idx} onClick={() => onItemClick(item)} className="w-full text-left p-3 rounded-xl bg-gray-50 dark:bg-gray-800/50 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition flex items-center gap-3 group">
                            <span className="w-2 h-2 rounded-full bg-primary-400 group-hover:bg-primary-500"></span>
                            <span className="text-sm font-medium text-gray-700 dark:text-gray-200 truncate">{item}</span>
                        </button>
                    ))}
                </div>
            </div>
        );

        // --- MAIN APP COMPONENT ---

        const App = () => {
            const [darkMode, setDarkMode] = useState(false);
            const [viewState, setViewState] = useState('hero');
            const [activePanel, setActivePanel] = useState(null);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState([{ type: 'ai', text: "Where is your dream destination?" }]);
            const [tripData, setTripData] = useState(null); 
            const [isLoading, setIsLoading] = useState(false);
            const [isFlying, setIsFlying] = useState(false);
            
            const [favorites, setFavorites] = useState(() => { try { return JSON.parse(localStorage.getItem('favorites') || '[]'); } catch { return []; } });
            const [history, setHistory] = useState(() => { try { return JSON.parse(localStorage.getItem('history') || '[]'); } catch { return []; } });

            const messagesEndRef = useRef(null);
            const orchestrator = useRef(new TourismOrchestrator());
            const gemini = useRef(new GeminiAgent());

            useEffect(() => localStorage.setItem('favorites', JSON.stringify(favorites)), [favorites]);
            useEffect(() => localStorage.setItem('history', JSON.stringify(history)), [history]);

            useEffect(() => {
                if (darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                lucide.createIcons();
            }, [darkMode, messages, viewState, activePanel, isSettingsOpen]);

            const executeSearch = async (query) => {
                const userText = query;
                setIsFlying(true);
                setActivePanel(null); 
                
                if (!history.includes(userText)) setHistory(prev => [userText, ...prev].slice(0, 10));

                setTimeout(() => {
                    setViewState('dashboard');
                    setMessages(prev => [...prev, { type: 'user', text: userText }]);
                    setIsLoading(true);
                    setIsFlying(false);
                }, 800);

                try {
                    const result = await orchestrator.current.process(userText);
                    
                    if (result.error) {
                        setMessages(prev => [...prev, { type: 'ai', text: result.error }]);
                        setIsLoading(false);
                    } else {
                        setTripData(result);
                        
                        setMessages(prev => [...prev, { type: 'ai', text: `I found ${result.city}. Here is your trip overview:` }]);
                        setMessages(prev => [...prev, { type: 'ai', uiType: 'weather', data: result.weather }]);
                        setMessages(prev => [...prev, { type: 'ai', uiType: 'attractions', data: result.places.list }]);
                        setMessages(prev => [...prev, { type: 'ai', uiType: 'location', data: { city: result.city } }]);

                        const insights = await gemini.current.getSmartInsights(result.city, result.weather.text, result.places.list);
                        setMessages(prev => [...prev, { type: 'ai', uiType: 'insights', data: insights }]);
                        setMessages(prev => [...prev, { type: 'ai', uiType: 'map', data: { lat: result.lat, lon: result.lon, city: result.city } }]);

                        setIsLoading(false);
                    }
                } catch (err) {
                    setMessages(prev => [...prev, { type: 'ai', text: "Something went wrong. Please try again." }]);
                    setIsLoading(false);
                }
            };

            const handleSearch = (e) => {
                e.preventDefault();
                if (!input.trim()) return;
                executeSearch(input);
                setInput("");
            };

            const handleSmartAction = async (type) => {
                if (!tripData) return;
                setIsLoading(true);
                const { city } = tripData;
                const weatherDesc = tripData.weather.raw.desc;
                let prompt = "";

                if (type === 'itinerary') prompt = `Create a simple 3-day itinerary for ${city}. Strictly follow this format: • **Day 1:** [Activities] • **Day 2:** [Activities] • **Day 3:** [Activities]`;
                else if (type === 'food dishes') prompt = `List 3-5 famous local dishes in ${city}. Strictly follow this format: • **Dish Name:** Description.`;
                else if (type === 'packing list') prompt = `List 5-7 essential packing items for ${city} considering weather is ${weatherDesc}. Format: • **Item:** Reason.`;
                else prompt = `${type} for ${city}. Keep it short.`;

                const text = await gemini.current.generateContent(prompt);
                setMessages(prev => [...prev, { type: 'ai', text: text }]);
                setIsLoading(false);
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            return (
                <div className="flex h-full relative z-0">
                    <div className="blob-bg">
                        <div className="blob bg-green-200 dark:bg-green-900/30 w-96 h-96 rounded-full top-0 left-0 mix-blend-multiply dark:mix-blend-screen filter blur-xl"></div>
                        <div className="blob bg-emerald-200 dark:bg-emerald-900/30 w-96 h-96 rounded-full top-0 right-0 animation-delay-2000 mix-blend-multiply dark:mix-blend-screen filter blur-xl"></div>
                    </div>

                    <SettingsModal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} />
                    <Sidebar darkMode={darkMode} setDarkMode={setDarkMode} setView={setViewState} activePanel={activePanel} setActivePanel={setActivePanel} onOpenSettings={() => setIsSettingsOpen(true)} />

                    {activePanel === 'favorites' && <SidePanel title="Favorites" type="favorites" items={favorites} onClose={() => setActivePanel(null)} onItemClick={(item) => executeSearch(`Plan a trip to ${item}`)} />}
                    {activePanel === 'history' && <SidePanel title="Recent History" type="history" items={history} onClose={() => setActivePanel(null)} onItemClick={(item) => executeSearch(item)} />}

                    <div className="md:hidden fixed top-0 w-full z-50 flex justify-between items-center p-4 bg-white/70 dark:bg-gray-900/70 backdrop-blur-lg border-b border-gray-200 dark:border-gray-800">
                        <div className="flex items-center gap-2"><div className="p-1.5 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg"><i data-lucide="plane" className="w-5 h-5 text-white"></i></div><span className="font-bold text-lg bg-clip-text text-transparent bg-gradient-to-r from-green-600 to-emerald-600">TravelAI</span></div>
                        <button onClick={() => setDarkMode(!darkMode)}><i data-lucide={darkMode ? "sun" : "moon"} className="w-5 h-5"></i></button>
                    </div>

                    <main className="flex-1 relative h-full overflow-hidden flex flex-col">
                        {viewState === 'hero' && (
                            <div className="absolute inset-0 z-40 flex flex-col items-center justify-center p-6 text-center animate-fade-in-up">
                                <div className="mb-8 relative">
                                    <div className="absolute inset-0 bg-gradient-to-r from-green-500 to-emerald-500 blur-3xl opacity-20 rounded-full"></div>
                                    <h1 className="text-5xl md:text-7xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-600 to-emerald-600 dark:from-green-400 dark:to-emerald-400 relative z-10 pb-2">What’s the next destination?</h1>
                                    <p className="mt-4 text-gray-500 dark:text-gray-400 text-lg">Explore the world with confidence—your journey starts here.</p>
                                </div>
                                <form onSubmit={handleSearch} className="w-full max-w-xl relative group">
                                <div className={`absolute -right-10 top-0 transition-all duration-700 ${isFlying ? 'animate-fly-plane opacity-100' : 'opacity-0'}`}><i data-lucide="plane" className="w-8 h-8 text-primary-500"></i></div>
                                <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="e.g., Bangkok, Paris, New York..." className="w-full px-8 py-6 rounded-full text-lg shadow-2xl border border-gray-100 bg-white text-gray-800 placeholder-gray-500 focus:ring-4 focus:ring-primary-100 transition outline-none" />
                                <button type="submit" className="absolute right-3 top-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white p-3 rounded-full transition shadow-lg hover:shadow-green-500/50"><i data-lucide="arrow-right" className="w-6 h-6"></i></button>
                            </form>
                            <div className="mt-12 flex gap-4 flex-wrap justify-center opacity-60">
                                {['Goa', 'Jaipur', 'Kerala'].map(city => (
                                        <button key={city} onClick={() => executeSearch(`Plan a trip to ${city}`)} className="px-4 py-2 rounded-full bg-white/50 dark:bg-gray-800/50 backdrop-blur border border-white/20 hover:scale-105 transition text-sm">{city}</button>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div className={`flex-1 flex flex-col h-full transition-opacity duration-500 ${viewState === 'hero' ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                            <div className="flex-1 flex flex-col h-full pt-16 md:pt-0 w-full">
                                <div className="flex-1 overflow-y-auto scrollbar-hide">
                                    <div className="max-w-3xl mx-auto p-4 md:p-8 space-y-4">
                                        {messages.map((msg, idx) => (
                                            <div key={idx}>
                                                {msg.uiType === 'location' ? <ChatLocationCard data={msg.data} /> :
                                                 msg.uiType === 'weather' ? <ChatWeatherCard data={msg.data} /> :
                                                 msg.uiType === 'insights' ? <ChatSmartInsightsCard data={msg.data} /> :
                                                 msg.uiType === 'attractions' ? <ChatAttractionsCard data={msg.data} /> :
                                                 msg.uiType === 'map' ? <ChatMapCard data={msg.data} /> :
                                                 <ChatBubble type={msg.type} text={msg.text} />
                                                }
                                            </div>
                                        ))}
                                        {isLoading && <div className="flex gap-2 p-4"><div className="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></div><div className="w-2 h-2 bg-primary-400 rounded-full animate-bounce delay-100"></div><div className="w-2 h-2 bg-primary-400 rounded-full animate-bounce delay-200"></div></div>}
                                        <div ref={messagesEndRef} />
                                    </div>
                                </div>
                                <div className="bg-white/40 dark:bg-gray-900/40 backdrop-blur-lg border-t border-white/20 dark:border-gray-700/30">
                                    <div className="max-w-3xl mx-auto p-4 md:p-6">
                                        <form onSubmit={handleSearch} className="relative">
                                            <input type="text" value={input} onChange={(e) => setInput(e.target.value)} placeholder="Ask anything..." className="w-full neumorph-input rounded-2xl px-6 py-4 pr-14 outline-none focus:ring-2 focus:ring-primary-400 transition shadow-lg" />
                                            <button type="submit" className="absolute right-3 top-3 p-2 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl text-white hover:from-green-600 hover:to-emerald-700 transition shadow-lg"><i data-lucide="send" className="w-4 h-4"></i></button>
                                        </form>
                                        {tripData && (
                                            <div className="flex gap-2 mt-3 overflow-x-auto pb-1 scrollbar-hide">
                                                <button onClick={() => handleSmartAction('itinerary')} className="flex items-center gap-1 px-3 py-2 text-xs font-medium rounded-xl bg-green-100 text-green-600 hover:bg-green-200 transition whitespace-nowrap shadow-sm hover:shadow-md">✨ Itinerary</button>
                                                <button onClick={() => handleSmartAction('food dishes')} className="flex items-center gap-1 px-3 py-2 text-xs font-medium rounded-xl bg-emerald-100 text-emerald-600 hover:bg-emerald-200 transition whitespace-nowrap shadow-sm hover:shadow-md">🍜 Local Food</button>
                                                <button onClick={() => handleSmartAction('packing list')} className="flex items-center gap-1 px-3 py-2 text-xs font-medium rounded-xl bg-lime-100 text-lime-600 hover:bg-lime-200 transition whitespace-nowrap shadow-sm hover:shadow-md">🎒 Packing</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>